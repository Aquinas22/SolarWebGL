<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Solar System</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #000; overflow: hidden; font-family: 'Times New Roman', serif; }
    canvas { display: block; }

    #hud {
      position: fixed;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 20px;
      letter-spacing: 0.1em;
      pointer-events: none;
      text-shadow: 0 0 8px rgba(255,220,100,0.6);
      transition: opacity 0.5s;
    }

    #controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255,255,255,0.45);
      font-size: 13px;
      letter-spacing: 0.08em;
      pointer-events: none;
      text-align: center;
      transition: opacity 0.5s;
    }

    #speed-control {
      position: fixed;
      top: 24px;
      right: 28px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      transition: opacity 0.5s;
    }

    #speed-control label {
      color: rgba(255,255,255,0.5);
      font-size: 12px;
      letter-spacing: 0.08em;
    }

    #speed-slider {
      -webkit-appearance: none;
      width: 120px;
      height: 3px;
      background: rgba(255,255,255,0.2);
      border-radius: 2px;
      outline: none;
      cursor: pointer;
    }
    #speed-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255, 200, 80, 0.9);
      cursor: pointer;
    }

    /* ── Info Panel (slides in from right) ── */
    #info-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 380px;
      height: 100%;
      padding: 60px 40px 40px;
      background: linear-gradient(to left, rgba(4,6,18,0.97) 70%, rgba(4,6,18,0));
      transform: translateX(100%);
      transition: transform 0.55s cubic-bezier(0.22, 1, 0.36, 1);
      overflow-y: auto;
      pointer-events: none;
    }

    #info-panel.visible {
      transform: translateX(0);
      pointer-events: all;
    }

    #panel-close {
      position: absolute;
      top: 20px;
      right: 24px;
      background: none;
      border: none;
      color: rgba(255,255,255,0.3);
      font-size: 20px;
      cursor: pointer;
      font-family: inherit;
      transition: color 0.2s;
    }
    #panel-close:hover { color: rgba(255,255,255,0.9); }

    #panel-name {
      font-size: 38px;
      font-weight: normal;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 0 0 30px rgba(200,220,255,0.5);
      margin-bottom: 6px;
    }

    #panel-subtitle {
      font-size: 11px;
      letter-spacing: 0.28em;
      color: rgba(255, 255, 255, 0.61);
      text-transform: uppercase;
      margin-bottom: 32px;
    }

    #panel-divider {
      width: 32px;
      height: 1px;
      background: rgba(255,255,255,0.18);
      margin-bottom: 30px;
    }

    #panel-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px 20px;
      margin-bottom: 32px;
      color: antiquewhite;
    }

    .stat-label {
      font-size: 9px;
      letter-spacing: 0.22em;
      color: rgba(255, 255, 255, 0.61);
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 14px;
      color: rgba(255,255,255,0.88);
      letter-spacing: 0.03em;
    }

    #panel-description {
      font-size: 14px;
      line-height: 1.85;
      color:antiquewhite;
    }

    canvas.hovering { cursor: pointer; }
  </style>
</head>
<body>

<div id="hud">Solar System for John</div>
<div id="controls">Left drag to rotate &nbsp;|&nbsp; Scroll to zoom &nbsp;|&nbsp; Click a planet for info</div>
<div id="speed-control">
  <label>SPEED SLIDER</label>
  <input type="range" id="speed-slider" min="0.001" max="10" step="0.001" value="1" />
</div>

<div id="info-panel">
  <button id="panel-close">✕</button>
  <div id="panel-name"></div>
  <div id="panel-subtitle"></div>
  <div id="panel-divider"></div>
  <div id="panel-stats"></div>
  <div id="panel-description"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
  // ---------------------------
  // Planet Info Data
  // ---------------------------
  const planetInfo = {
    Mercury: {
      subtitle: 'First planet from the Sun',
      stats: [
        { label: 'Diameter',          value: '4,879 km' },
        { label: 'Day Length',        value: '58.6 Earth days' },
        { label: 'Year Length',       value: '88 Earth days' },
        { label: 'Avg Temperature',   value: '167°C' },
        { label: 'Moons',             value: '0' },
        { label: 'Distance from Sun', value: '57.9M km' },
      ],
      description: 'The smallest planet in our solar system and closest to the Sun. Mercury has almost no atmosphere, so it cannot retain heat — its surface temperature swings wildly from −180°C at night to 430°C during the day.',
    },
    Venus: {
      subtitle: 'Second planet from the Sun',
      stats: [
        { label: 'Diameter',          value: '12,104 km' },
        { label: 'Day Length',        value: '243 Earth days' },
        { label: 'Year Length',       value: '225 Earth days' },
        { label: 'Avg Temperature',   value: '464°C' },
        { label: 'Moons',             value: '0' },
        { label: 'Distance from Sun', value: '108.2M km' },
      ],
      description: 'Often called Earth\'s twin due to its similar size, Venus is the hottest planet in the solar system. Its thick atmosphere of carbon dioxide creates a runaway greenhouse effect, and it rotates in the opposite direction to most planets.',
    },
    Earth: {
      subtitle: 'Third planet from the Sun',
      stats: [
        { label: 'Diameter',          value: '12,742 km' },
        { label: 'Day Length',        value: '24 hours' },
        { label: 'Year Length',       value: '365.25 days' },
        { label: 'Avg Temperature',   value: '15°C' },
        { label: 'Moons',             value: '1' },
        { label: 'Distance from Sun', value: '149.6M km' },
      ],
      description: 'Our home — created by God and given to humanity as a gift. All history, life, culture and love is here on this little blue and green planet. Earth floats in the vastness of space under the loving care of Our Lord.',
    },
    Mars: {
      subtitle: 'Fourth planet from the Sun',
      stats: [
        { label: 'Diameter',          value: '6,779 km' },
        { label: 'Day Length',        value: '24.6 hours' },
        { label: 'Year Length',       value: '687 Earth days' },
        { label: 'Avg Temperature',   value: '−60°C' },
        { label: 'Moons',             value: '2' },
        { label: 'Distance from Sun', value: '227.9M km' },
      ],
      description: 'The Red Planet — its rusty colour comes from iron oxide on its surface. Mars hosts the tallest volcano in the solar system, Olympus Mons, and has seasons, polar ice caps, and a day remarkably similar in length to Earth\'s.',
    },
    Jupiter: {
      subtitle: 'Fifth planet from the Sun',
      stats: [
        { label: 'Diameter',          value: '139,820 km' },
        { label: 'Day Length',        value: '9.9 hours' },
        { label: 'Year Length',       value: '11.9 Earth years' },
        { label: 'Avg Temperature',   value: '−110°C' },
        { label: 'Moons',             value: '95' },
        { label: 'Distance from Sun', value: '778.5M km' },
      ],
      description: 'The king of the solar system — more massive than all other planets combined. Jupiter\'s iconic Great Red Spot is a storm that has raged for over 350 years. Its powerful gravity acts as a shield, deflecting many asteroids away from the inner planets.',
    },
    Saturn: {
      subtitle: 'Sixth planet from the Sun',
      stats: [
        { label: 'Diameter',          value: '116,460 km' },
        { label: 'Day Length',        value: '10.7 hours' },
        { label: 'Year Length',       value: '29.5 Earth years' },
        { label: 'Avg Temperature',   value: '−140°C' },
        { label: 'Moons',             value: '146' },
        { label: 'Distance from Sun', value: '1.43B km' },
      ],
      description: 'Saturn\'s stunning ring system — made of ice and rock — stretches up to 282,000 km from the planet but is remarkably thin, often less than 1 km deep. It is the least dense planet in the solar system; it would float on water.',
    },
    Uranus: {
      subtitle: 'Seventh planet from the Sun',
      stats: [
        { label: 'Diameter',          value: '50,724 km' },
        { label: 'Day Length',        value: '17.2 hours' },
        { label: 'Year Length',       value: '84 Earth years' },
        { label: 'Avg Temperature',   value: '−195°C' },
        { label: 'Moons',             value: '28' },
        { label: 'Distance from Sun', value: '2.87B km' },
      ],
      description: 'The tilted planet — Uranus rotates on its side with an axial tilt of nearly 98°, likely the result of a massive collision long ago. It is an ice giant with a pale blue-green hue from methane in its atmosphere.',
    },
    Neptune: {
      subtitle: 'Eighth planet from the Sun',
      stats: [
        { label: 'Diameter',          value: '49,244 km' },
        { label: 'Day Length',        value: '16.1 hours' },
        { label: 'Year Length',       value: '165 Earth years' },
        { label: 'Avg Temperature',   value: '−200°C' },
        { label: 'Moons',             value: '16' },
        { label: 'Distance from Sun', value: '4.5B km' },
      ],
      description: 'The windiest planet, with storms reaching 2,100 km/h — the fastest in the solar system. Neptune was the first planet predicted by mathematics before it was observed. Its largest moon, Triton, orbits backwards and is slowly spiralling inward.',
    },
  };

  // ---------------------------
  // Scene, Camera, Renderer
  // ---------------------------
  const scene = new THREE.Scene();

  const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.set(0, 10, 30);
  camera.lookAt(0, 0, 0);

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  document.body.appendChild(renderer.domElement);

  // ---------------------------
  // Lighting
  // ---------------------------
  const sunLight = new THREE.PointLight(0xfffae0, 4.0, 30);
  sunLight.position.set(0, 0, 0);
  scene.add(sunLight);

  const ambientLight = new THREE.AmbientLight(0xffffff, 0.55);
  scene.add(ambientLight);

  // ---------------------------
  // Texture Loader
  // ---------------------------
  const loader = new THREE.TextureLoader();
  function loadTex(path) { return loader.load(path); }

  // ---------------------------
  // Skybox
  // ---------------------------
  const skybox = new THREE.Mesh(
          new THREE.BoxGeometry(500, 500, 500),
          new THREE.MeshBasicMaterial({ map: loadTex('assets/background.jpg'), side: THREE.BackSide })
  );
  scene.add(skybox);

  // ---------------------------
  // Sun
  // ---------------------------
  const sun = new THREE.Mesh(
          new THREE.SphereGeometry(1.5, 32, 32),
          new THREE.MeshBasicMaterial({ map: loadTex('assets/sun.jpg') })
  );
  scene.add(sun);

  // ---------------------------
  // Helper: Orbit Line
  // ---------------------------
  function createOrbitLine(radius) {
    const points = [];
    for (let i = 0; i <= 128; i++) {
      const theta = (i / 128) * Math.PI * 2;
      points.push(new THREE.Vector3(Math.cos(theta) * radius, 0, Math.sin(theta) * radius));
    }
    const geo = new THREE.BufferGeometry().setFromPoints(points);
    return new THREE.Line(geo, new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.25 }));
  }

  // ---------------------------
  // Helper: Saturn Ring
  // ---------------------------
  function createRing(innerRadius, outerRadius, texturePath) {
    const geo = new THREE.RingGeometry(innerRadius, outerRadius, 128, 8);
    const pos = geo.attributes.position;
    const uv  = geo.attributes.uv;
    const v3  = new THREE.Vector3();
    for (let i = 0; i < pos.count; i++) {
      v3.fromBufferAttribute(pos, i);
      const r = v3.length();
      const t = (r - innerRadius) / (outerRadius - innerRadius);
      const u = (Math.atan2(v3.y, v3.x) / (Math.PI * 2) + 1) % 1;
      uv.setXY(i, u, t);
    }
    uv.needsUpdate = true;
    return new THREE.Mesh(geo, new THREE.MeshBasicMaterial({
      map: loadTex(texturePath), side: THREE.DoubleSide, transparent: true, opacity: 0.9, depthWrite: false,
    }));
  }

  // ---------------------------
  // Planet Data
  // ---------------------------
  const planetsData = [
    { name: 'Mercury', radius: 0.10, texture: 'assets/mercury.jpg', orbit: 2.0,  speed: 4.15,  tilt: 0.03  },
    { name: 'Venus',   radius: 0.20, texture: 'assets/venus.jpg',   orbit: 3.0,  speed: 1.62,  tilt: 177.4 },
    { name: 'Earth',   radius: 0.25, texture: 'assets/earth.jpg',   orbit: 4.0,  speed: 1.0,   tilt: 23.5  },
    { name: 'Mars',    radius: 0.15, texture: 'assets/mars.jpg',    orbit: 5.0,  speed: 0.53,  tilt: 25.2  },
    { name: 'Jupiter', radius: 0.50, texture: 'assets/jupiter.jpg', orbit: 7.0,  speed: 0.084, tilt: 3.1   },
    { name: 'Saturn',  radius: 0.45, texture: 'assets/saturn.jpg',  orbit: 9.0,  speed: 0.034, tilt: 26.7,
      hasRings: true, ringInner: 0.45 * 1.2, ringOuter: 0.45 * 2.0, ringTexture: 'assets/saturn.jpg' },
    { name: 'Uranus',  radius: 0.35, texture: 'assets/uranus.jpg',  orbit: 11.0, speed: 0.011, tilt: 97.8  },
    { name: 'Neptune', radius: 0.35, texture: 'assets/neptune.jpg', orbit: 13.0, speed: 0.006, tilt: 28.3  },
  ];

  const planets = planetsData.map(data => {
    const pivot = new THREE.Object3D();
    scene.add(pivot);
    scene.add(createOrbitLine(data.orbit));

    const mesh = new THREE.Mesh(
            new THREE.SphereGeometry(data.radius, 32, 32),
            new THREE.MeshLambertMaterial({ map: loadTex(data.texture) })
    );
    mesh.rotation.z = THREE.MathUtils.degToRad(data.tilt || 23.5);
    mesh.position.x = data.orbit;
    pivot.add(mesh);

    // White glow outline — slightly larger sphere, renders only back faces
    const glowMesh = new THREE.Mesh(
            new THREE.SphereGeometry(data.radius * 1.03, 32, 32),
            new THREE.MeshBasicMaterial({ color: 0xffffff, side: THREE.BackSide, transparent: true, opacity: 0 })
    );
    mesh.add(glowMesh);

    if (data.hasRings) {
      const ring = createRing(data.ringInner, data.ringOuter, data.ringTexture);
      ring.rotation.x = Math.PI / 2;
      mesh.add(ring);
    }

    return { ...data, pivot, mesh, glowMesh, orbitAngle: Math.random() * Math.PI * 2, spinSpeed: 0.5 };
  });

  // ---------------------------
  // Raycasting
  // ---------------------------
  const raycaster = new THREE.Raycaster();
  const mouse = new THREE.Vector2();
  const planetMeshes = planets.map(p => p.mesh);

  // ---------------------------
  // Camera animation state
  // ---------------------------
  let cameraTheta  = 0;
  let cameraPhi    = 0.35;
  let cameraRadius = 30;

  // Zoom targets
  let zoomTarget   = null;   // planet being zoomed to
  let zoomProgress = 1;      // 0 = start of zoom, 1 = arrived
  let savedTheta   = 0;
  let savedPhi     = 0;
  let savedRadius  = 30;
  let fromTheta    = 0;
  let fromPhi      = 0;
  let fromRadius   = 30;

  // Glow animation
  let activePlanet = null;

  function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }

  // ---------------------------
  // Panel open / close
  // ---------------------------
  let panelOpen = false;

  function openPanel(planet) {
    if (panelOpen && activePlanet === planet) return;

    // Fade out any previous glow
    if (activePlanet && activePlanet !== planet) {
      activePlanet.glowMesh.material.opacity = 0;
    }

    activePlanet = planet;
    panelOpen    = true;

    // Save current camera state and set zoom targets
    savedTheta  = cameraTheta;
    savedPhi    = cameraPhi;
    savedRadius = cameraRadius;
    fromTheta   = cameraTheta;
    fromPhi     = cameraPhi;
    fromRadius  = cameraRadius;
    zoomTarget  = planet;
    zoomProgress = 0;

    // Fade HUD
    document.getElementById('hud').style.opacity          = '0';
    document.getElementById('controls').style.opacity     = '0';
    document.getElementById('speed-control').style.opacity = '0';

    // Populate panel text
    const info = planetInfo[planet.name];
    document.getElementById('panel-name').textContent     = planet.name.toUpperCase();
    document.getElementById('panel-subtitle').textContent = info.subtitle;
    document.getElementById('panel-stats').innerHTML = info.stats.map(s =>
            `<div class="stat-item">
       <div class="stat-label">${s.label}</div>
       <div class="stat-value">${s.value}</div>
     </div>`
    ).join('');
    document.getElementById('panel-description').textContent = info.description;

    document.getElementById('info-panel').classList.add('visible');
  }

  function closePanel() {
    panelOpen = false;

    // Fade out glow
    if (activePlanet) activePlanet.glowMesh.material.opacity = 0;
    activePlanet = null;
    zoomTarget   = null;

    // Restore camera
    fromTheta  = cameraTheta;
    fromPhi    = cameraPhi;
    fromRadius = cameraRadius;
    // Animate back
    zoomProgress = 0;
    zoomTarget   = 'restore';

    document.getElementById('info-panel').classList.remove('visible');
    document.getElementById('hud').style.opacity           = '1';
    document.getElementById('controls').style.opacity      = '1';
    document.getElementById('speed-control').style.opacity = '1';
  }

  document.getElementById('panel-close').addEventListener('click', closePanel);

  // ---------------------------
  // Mouse Controls
  // ---------------------------
  let mouseDown = false, didDrag = false, lastX = 0, lastY = 0;

  renderer.domElement.addEventListener('mousedown', e => {
    mouseDown = true; didDrag = false;
    lastX = e.clientX; lastY = e.clientY;
  });
  renderer.domElement.addEventListener('mouseup', e => {
    mouseDown = false;
    if (!didDrag) handleClick(e);
  });
  renderer.domElement.addEventListener('mouseleave', () => mouseDown = false);

  renderer.domElement.addEventListener('mousemove', e => {
    if (mouseDown && !panelOpen) {
      const dx = e.clientX - lastX;
      const dy = e.clientY - lastY;
      if (Math.abs(dx) > 2 || Math.abs(dy) > 2) didDrag = true;
      cameraTheta -= dx * 0.005;
      cameraPhi = Math.max(0.05, Math.min(Math.PI / 2, cameraPhi + dy * 0.005));
      lastX = e.clientX; lastY = e.clientY;
    }

    if (!panelOpen) {
      mouse.x =  (e.clientX / window.innerWidth)  * 2 - 1;
      mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
      raycaster.setFromCamera(mouse, camera);
      renderer.domElement.classList.toggle('hovering', raycaster.intersectObjects(planetMeshes).length > 0);
    }
  });

  renderer.domElement.addEventListener('wheel', e => {
    if (panelOpen) return;
    cameraRadius = Math.max(5, Math.min(100, cameraRadius + e.deltaY * 0.05));
  }, { passive: true });

  function handleClick(e) {
    mouse.x =  (e.clientX / window.innerWidth)  * 2 - 1;
    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);
    const hits = raycaster.intersectObjects(planetMeshes);
    if (hits.length > 0) {
      const planet = planets.find(p => p.mesh === hits[0].object);
      if (planet) openPanel(planet);
    } else if (panelOpen) {
      closePanel();
    }
  }

  // Touch
  let lastTouchX = 0, lastTouchY = 0;
  renderer.domElement.addEventListener('touchstart', e => { lastTouchX = e.touches[0].clientX; lastTouchY = e.touches[0].clientY; });
  renderer.domElement.addEventListener('touchmove', e => {
    if (panelOpen) return;
    cameraTheta -= (e.touches[0].clientX - lastTouchX) * 0.005;
    cameraPhi = Math.max(0.05, Math.min(Math.PI / 2, cameraPhi - (e.touches[0].clientY - lastTouchY) * 0.005));
    lastTouchX = e.touches[0].clientX; lastTouchY = e.touches[0].clientY;
  });

  // ---------------------------
  // Speed Control
  // ---------------------------
  let timeScale = 1.0;
  document.getElementById('speed-slider').addEventListener('input', e => { timeScale = parseFloat(e.target.value); });

  // ---------------------------
  // Resize
  // ---------------------------
  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  // ---------------------------
  // Animation Loop
  // ---------------------------
  const hud    = document.getElementById('hud');
  const startT = performance.now();
  let lastT    = performance.now();

  function getPlanetWorldPos(planet) {
    const wp = new THREE.Vector3();
    planet.mesh.getWorldPosition(wp);
    return wp;
  }

  function animate() {
    requestAnimationFrame(animate);

    const now = performance.now();
    const dt  = Math.min((now - lastT) / 1000, 0.05) * timeScale;
    lastT = now;

    // hud.textContent = `Years: ${((now - startT) / 1000 * timeScale / (2 * Math.PI)).toFixed(1)}`;

    sun.rotation.y += 0.003;

    planets.forEach(p => {
      p.orbitAngle += p.speed * dt;
      p.pivot.rotation.y = p.orbitAngle;
      p.mesh.rotation.y  += 0.01 * p.spinSpeed;
    });

    // ── Camera zoom animation ──
    // We position camera offset from the planet's world pos, not from the origin
    let lookAtTarget = new THREE.Vector3(0, 0, 0);

    if (zoomTarget && zoomTarget !== 'restore') {
      const wp = getPlanetWorldPos(zoomTarget);
      const closeRadius = zoomTarget.radius * 7 + 1.5;

      if (zoomProgress < 1) {
        zoomProgress = Math.min(zoomProgress + 0.022, 1);
        const t = easeOutCubic(zoomProgress);
        zoomTarget.glowMesh.material.opacity = t * 0.55;

        // Interpolate camera from its current world pos toward offset behind the planet
        const camOffset = new THREE.Vector3(0, closeRadius * 0.3, closeRadius)
                .applyAxisAngle(new THREE.Vector3(0, 1, 0), Math.atan2(wp.x, wp.z));

        const fromPos = new THREE.Vector3(
                fromRadius * Math.sin(fromTheta) * Math.cos(fromPhi),
                fromRadius * Math.sin(fromPhi),
                fromRadius * Math.cos(fromTheta) * Math.cos(fromPhi)
        );
        const toPos = wp.clone().add(camOffset);
        camera.position.lerpVectors(fromPos, toPos, t);
        lookAtTarget.lerpVectors(new THREE.Vector3(0,0,0), wp, t);
      } else {
        // Locked: keep orbiting with the planet
        const camOffset = new THREE.Vector3(0, closeRadius * 0.3, closeRadius)
                .applyAxisAngle(new THREE.Vector3(0, 1, 0), Math.atan2(wp.x, wp.z));
        camera.position.copy(wp).add(camOffset);
        lookAtTarget.copy(wp);
        zoomTarget.glowMesh.material.opacity = 0.55;
      }

    } else if (zoomTarget === 'restore') {
      zoomProgress = Math.min(zoomProgress + 0.03, 1);
      const t = easeOutCubic(zoomProgress);
      const toPos = new THREE.Vector3(
              savedRadius * Math.sin(savedTheta) * Math.cos(savedPhi),
              savedRadius * Math.sin(savedPhi),
              savedRadius * Math.cos(savedTheta) * Math.cos(savedPhi)
      );
      camera.position.lerp(toPos, t);
      lookAtTarget.set(0, 0, 0);
      if (zoomProgress >= 1) {
        zoomTarget = null;
        cameraTheta  = savedTheta;
        cameraPhi    = savedPhi;
        cameraRadius = savedRadius;
      }

    } else {
      // Normal free camera
      camera.position.set(
              cameraRadius * Math.sin(cameraTheta) * Math.cos(cameraPhi),
              cameraRadius * Math.sin(cameraPhi),
              cameraRadius * Math.cos(cameraTheta) * Math.cos(cameraPhi)
      );
    }

    camera.lookAt(lookAtTarget);

    renderer.render(scene, camera);
  }

  animate();
</script>
</body>
</html>